clearvars -except data
close all
% simulation setup:

verbose = 0;
% M_SS = check_gen_M_SS(); % XXX finish
fn = 'example_data/All recorded points .mat';
if not(exist('data', 'var'))
    data = importdata(fn);
end

% t U:
pjvsdata = [
0.000000000	0.000000000; ...
0.000250000	0.141563890; ...
0.000500000	0.282838284; ...
0.000750000	0.424402174; ...
0.001000000	0.565676567; ...
0.001250000	0.707240457; ...
0.001500000	0.848514851; ...
0.001750000	0.990078741; ...
0.002000000	1.131353134; ...
0.002250000	1.272772276; ...
0.002500000	1.414336166; ...
0.002750000	1.272772276; ...
0.003000000	1.131353134; ...
0.003250000	0.990078741; ...
0.003500000	0.848514851; ...
0.003750000	0.707240457; ...
0.004000000	0.565676567; ...
0.004250000	0.424402174; ...
0.004500000	0.282838284; ...
0.004750000	0.141563890; ...
0.005000000	0.000000000; ...
0.005250000	-0.141563890; ...
0.005500000	-0.282838284; ...
0.005750000	-0.424402174; ...
0.006000000	-0.565676567; ...
0.006250000	-0.707240457; ...
0.006500000	-0.848514851; ...
0.006750000	-0.990078741; ...
0.007000000	-1.131353134; ...
0.007250000	-1.272772276; ...
0.007500000	-1.414336166; ...
0.007750000	-1.272772276; ...
0.008000000	-1.131353134; ...
0.008250000	-0.990078741; ...
0.008500000	-0.848514851; ...
0.008750000	-0.707240457; ...
0.009000000	-0.565676567; ...
0.009250000	-0.424402174; ...
0.009500000	-0.282838284; ...
0.009750000	-0.141563890; ...
];


% digitizer gain = 1.000152
% 40 periods Calibrator: 100 kHz, 1 V nom which is about 110 ppm low at 1 kHz %
M_SS.fs.v = 4e6; % Sa/s hopefully correct   
M_SS.f.v = 100e3; % seems to be ok
M_SS.f_envelope.v = 20; % seems to be ok
steps_in_period = 40; % seems to be ok

M_SS.y.v = data(1, :); %(1, 1:200e3); % TAKE ONLY ONE PERIOD OF TRIANGLE FOR THIS TESTING
Ts = 1/M_SS.fs.v;
M_SS.t.v = Ts.*[1 : numel(M_SS.y.v)] - Ts;
M_SS.f_step.v = steps_in_period.*M_SS.f_envelope.v;
Sstep = M_SS.fs.v./M_SS.f_step.v;
M_SS.Spjvs.v = [ 1 Sstep.*[1 : steps_in_period] numel(M_SS.y.v)+1 ];
M_SS.Rs.v = M_SS.fs.v/M_SS.f.v; % multiples of 100 kHz waveform
M_SS.Re.v = M_SS.Rs.v;
M_SS.Upjvs.v = pjvsdata(:, 2);
if verbose
    plot(M_SS.t.v, M_SS.y.v);
end

[A_rms, A_fft] = P_SS(M_SS, verbose);
M_SS.A_nominal.v = sqrt(2); % XXX not sure if this is correct!
disp('---')
printf('Nominal amplitude (V): %.7f\n', M_SS.A_nominal.v)
printf('Calculated mean amplitude from RMS value (V): %.7f\n', mean(A_rms))
printf('... error (uV): %.3f\n', 1e6.*(M_SS.A_nominal.v - mean(A_rms) ))
printf('Calculated amplitude from FFT value (V): %.7f\n', mean(A_fft) )
printf('... error (uV): %.3f\n', 1e6.*(M_SS.A_nominal.v - mean(A_fft) ))

% vim settings modeline: vim: foldmarker=%<<<,%>>> fdm=marker fen ft=octave textwidth=80 tabstop=4 shiftwidth=4

